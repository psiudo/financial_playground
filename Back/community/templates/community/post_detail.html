<!-- community/templates/community/post_detail.html -->
{% extends "base.html" %}

{% block content %}

<h2>{{ post.title }}</h2>
<p><strong>ì‘ì„±ì:</strong> {{ post.author.username }}</p>
<p><strong>ì‘ì„±ì¼:</strong> {{ post.created_at|date:"Y-m-d H:i" }}</p>
<hr>
<p>{{ post.content }}</p>
<hr>

<!-- ë°˜ì‘ ë²„íŠ¼ -->
<form action="{% url 'community:toggle_reaction' post.id 'like' %}" method="POST" style="display:inline;">
  {% csrf_token %}
  <button type="submit" {% if user.is_authenticated and 'like' in user_reaction_types %}style="font-weight:bold;"{% endif %}>
    ğŸ‘ ì¢‹ì•„ìš” ({{ reaction_counts.like }})
  </button>
</form>

<form action="{% url 'community:toggle_reaction' post.id 'useful' %}" method="POST" style="display:inline;">
  {% csrf_token %}
  <button type="submit" {% if user.is_authenticated and 'useful' in user_reaction_types %}style="font-weight:bold;"{% endif %}>
    ğŸ’¡ ìœ ìš©í•´ìš” ({{ reaction_counts.useful }})
  </button>
</form>

<form action="{% url 'community:toggle_reaction' post.id 'sad' %}" method="POST" style="display:inline;">
  {% csrf_token %}
  <button type="submit" {% if user.is_authenticated and 'sad' in user_reaction_types %}style="font-weight:bold;"{% endif %}>
    ğŸ˜¢ ìŠ¬í¼ìš” ({{ reaction_counts.sad }})
  </button>
</form>

<form action="{% url 'community:toggle_reaction' post.id 'hard' %}" method="POST" style="display:inline;">
  {% csrf_token %}
  <button type="submit" {% if user.is_authenticated and 'hard' in user_reaction_types %}style="font-weight:bold;"{% endif %}>
    ğŸ˜– ì–´ë ¤ì›Œìš” ({{ reaction_counts.hard }})
  </button>
</form>

<hr>

<!-- ëŒ“ê¸€ ëª©ë¡ -->
<h3>ëŒ“ê¸€ ëª©ë¡</h3>

{% for comment in top_level_comments %}
  <div style="margin-bottom:10px;">
    <strong>{{ comment.author.username }}</strong> ({{ comment.created_at|date:"Y-m-d H:i" }})<br>

    {% if comment.id == edit_comment_id %}
      <form method="post" action="{% url 'community:comment_update' comment.id %}">
        {% csrf_token %}
        <input type="text" name="content" value="{{ comment.content }}" size="50">
        <button type="submit">ìˆ˜ì • ì™„ë£Œ</button>
        <a href="{% url 'community:post_detail' post.id %}">ì·¨ì†Œ</a>
      </form>
    {% else %}
      <p>{{ comment.content }}</p>

      {% if user.is_authenticated %}
        <form method="get" action="{% url 'community:post_detail' post.id %}" style="display:inline;">
          <input type="hidden" name="edit_comment_id" value="{{ comment.id }}">
          <button type="submit">ìˆ˜ì •</button>
        </form>

        <form method="post" action="{% url 'community:comment_delete' comment.id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit">ì‚­ì œ</button>
        </form>

        <form method="post" action="{% url 'community:comment_toggle_like' comment.id %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit">â¤ï¸ {{ comment.reactions.count }}</button>
        </form>
      {% endif %}
    {% endif %}

    <!-- ëŒ€ëŒ“ê¸€ -->
    {% for reply in comment.replies.all %}
      <div style="margin-left:20px; margin-top:5px;">
        â†³ <strong>{{ reply.author.username }}</strong> ({{ reply.created_at|date:"Y-m-d H:i" }})<br>

        {% if reply.id == edit_comment_id %}
          <form method="post" action="{% url 'community:comment_update' reply.id %}">
            {% csrf_token %}
            <input type="text" name="content" value="{{ reply.content }}" size="50">
            <button type="submit">ìˆ˜ì • ì™„ë£Œ</button>
            <a href="{% url 'community:post_detail' post.id %}">ì·¨ì†Œ</a>
          </form>
        {% else %}
          <p>{{ reply.content }}</p>

          {% if user.is_authenticated %}
            <form method="get" action="{% url 'community:post_detail' post.id %}" style="display:inline;">
              <input type="hidden" name="edit_comment_id" value="{{ reply.id }}">
              <button type="submit">ìˆ˜ì •</button>
            </form>

            <form method="post" action="{% url 'community:comment_delete' reply.id %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit">ì‚­ì œ</button>
            </form>

            <form method="post" action="{% url 'community:comment_toggle_like' reply.id %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit">â¤ï¸ {{ reply.reactions.count }}</button>
            </form>
          {% endif %}
        {% endif %}
      </div>
    {% endfor %}

    {% if user.is_authenticated %}
      <div style="margin-left:20px; margin-top:10px;">
        <form method="post" action="{% url 'community:comment_create' %}">
          {% csrf_token %}
          <input type="hidden" name="post" value="{{ post.id }}">
          <input type="hidden" name="parent" value="{{ comment.id }}">
          <textarea name="content" rows="2" cols="40" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea><br>
          <button type="submit">ë‹µê¸€ ì‘ì„±</button>
        </form>
      </div>
    {% endif %}
  </div>
{% empty %}
  <p>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endfor %}

<hr>

<!-- ìµœìƒìœ„ ëŒ“ê¸€ ì‘ì„± -->
{% if user.is_authenticated %}
<h3>ëŒ“ê¸€ ì‘ì„±</h3>
<form method="post" action="{% url 'community:comment_create' %}">
  {% csrf_token %}
  <input type="hidden" name="post" value="{{ post.id }}">
  <textarea name="content" rows="3" cols="50" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea><br>
  <button type="submit">ëŒ“ê¸€ ì‘ì„±</button>
</form>
{% else %}
<p>ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
{% endif %}

{% endblock content %}
