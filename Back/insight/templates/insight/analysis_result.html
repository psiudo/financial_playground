<!-- Back/insight/templates/insight/analysis_result.html -->
{% extends "base.html" %}
{% load humanize %}          {# ìˆ«ìì— , ì°ì–´ì£¼ê¸° ë“± #}
{% block content %}

<div class="container my-4">

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">{{ stock.company_name }}Â ëŒ“ê¸€</h2>

    <div>
      <button class="btn btn-secondary me-2"
              onclick="location.href='{% url 'insight:refresh_comments' stock.id %}'">
        ğŸ”„Â ëŒ“ê¸€ ìƒˆë¡œê³ ì¹¨
      </button>

      <form class="d-inline" method="post"
            action="{% url 'insight:perform_analysis' stock.id %}">
        {% csrf_token %}
        <button id="analyzeBtn"
                class="btn btn-primary"
                {% if not analysis.batch_ready %}disabled{% endif %}>
          ğŸ§ Â ê°ì • ë¶„ì„í•˜ê¸°
        </button>
      </form>
    </div>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë°°ì¹˜ ì¤€ë¹„ ìƒíƒœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  {% if not analysis.batch_ready %}
    <div id="waitMsg" class="alert alert-warning py-2">
      ë°°ì¹˜ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤â€¦ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.
    </div>
  {% endif %}

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ëŒ“ê¸€ í‘œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <table class="table table-striped align-middle">
    <thead class="table-light">
      <tr>
        <th style="width: 140px">í† ìŠ¤ ìœ ì €</th>
        <th>ëŒ“ê¸€ ë‚´ìš©</th>
        <th class="text-end" style="width: 90px">ê³µê°</th>
        <th style="width: 120px">ì‘ì„±ì¼</th>
      </tr>
    </thead>
    <tbody>
      {% for c in analysis.comments.all %}
        <tr>
          <td>{{ c.author }}</td>
          <td>{{ c.content|linebreaksbr }}</td>
          <td class="text-end">{{ c.likes|intcomma }}</td>
          <td>{{ c.written_at }}</td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="4" class="text-center text-muted">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë¶„ì„ ê²°ê³¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  {% if analysis.summary %}
    <hr>
    <h4 class="mt-4">âœï¸Â ìš”ì•½</h4>
    <p>{{ analysis.summary }}</p>

    <h5 class="mt-3">ğŸ·Â í‚¤ì›Œë“œ</h5>
    {% for kw in analysis.keywords %}
      <span class="badge bg-info text-dark me-1">{{ kw }}</span>
    {% endfor %}

    <h5 class="mt-3">ğŸ“ŠÂ ê°ì •Â í†µê³„</h5>
    <ul class="list-inline">
      {% for k, v in analysis.sentiment_stats.items %}
        <li class="list-inline-item">
          <span class="badge bg-light text-dark">{{ k }}: {{ v|intcomma }}</span>
        </li>
      {% endfor %}
    </ul>
  {% endif %}
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ í´ë§ ìŠ¤í¬ë¦½íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
{% if not analysis.batch_ready %}
  const btn  = document.getElementById("analyzeBtn");
  const wait = document.getElementById("waitMsg");

  const poll = setInterval(() => {
    fetch("{% url 'insight:analysis_status' stock.id %}")
      .then(r => r.json())
      .then(d => {
        if (d.ready) {
          btn.disabled = false;
          wait.classList.replace('alert-warning', 'alert-success');
          wait.textContent = "ë°°ì¹˜ ì™„ë£Œ! ê°ì • ë¶„ì„ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
          clearInterval(poll);
        }
      });
  }, 1500);
{% endif %}
</script>

{% endblock %}
